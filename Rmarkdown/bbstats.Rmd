---
title: "Data Visualization of Pre and Post Trimmmed Nanopore reads: Statistics from bbtools statswrapper"
author: "Prakki Sai Rama Sridatta"
date: "6/16/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Step 1: Filter Long reads 

All the raw fastq reads for the samples are processed using the tool "filtlong" using the following command.

```{r filtlong, engine = 'bash', eval = FALSE}
time for d in $(ls *.fastq | sed 's/.fastq//g'); 
do 
filtlong --min_length 1000 --keep_percent 90 --target_bases 500000000 "$d".fastq > "$d".filtlong.fastq & 
done
```

### Step 2: Generate read statistics
Now that we have both raw and filtered fastq files run bbtools statswrapper.sh

```{r stats, engine = 'bash', eval = FALSE}
time statswrapper.sh *.fastq >bbstats_wrapper.txt 
```

### Step 3: Generate R plots
Let us load the **bbstats_wrapper.txt** file into R and generate some figures from the data using R ggplot function.
```{r bb, message=FALSE}

setwd("/data02/Analysis/Projects/8_Aqueos_samples/11F/bbstats/")

library(dplyr)
library(ggplot2)
library(ggunchained)
library(kableExtra)

bbstats <- read.table("bbstats_wrapper.txt", sep = "\t", header = TRUE)

# Since the table is very big outputting the contents into table with scroll bar
head(bbstats) %>%
  kbl() %>%
   kable_paper() %>%
  scroll_box(width = "100%", height = "200px")

# Subsetting columns to a smaller dataframe for ease of analysis
bbstats_filtered <- bbstats %>% select(n_contigs, contig_bp, ctg_N50,ctg_max,filename,Sample)

#renaming column names
colnames(bbstats_filtered) <- c("ReadCount","Totalbases", "N50","LongestRead","Filename", "Sample")

# Since the table is small outputting the contents into kable table
 head(bbstats_filtered) %>%
  kbl() %>%
  kable_classic_2(full_width = F)

# Parsing data  
bbstats_filtered <- bbstats_filtered %>% 
      mutate(data = case_when(grepl("_NP.filtlong", Filename) ~ "Filtered",
                              grepl("_NP", Filename, ignore.case = TRUE) ~"Raw")) %>% 
          select(-Filename) 

# Since the table is small outputting the contents into kable table
 head(bbstats_filtered) %>%
  kbl() %>%
  kable_classic_2(full_width = F)

#N50 Dumbbell plot 
ggplot(bbstats_filtered, aes(x=N50, y=reorder(Sample,N50))) + 
  geom_line(aes(group = Sample))+
  geom_point(aes(color=data), size=1) +
  theme_light()+
  theme(legend.position="top", axis.text.x = element_text(angle = 90, hjust = 1, size = 6), axis.text.y = element_text(angle = 0, hjust = 1, size = 5)) +
  scale_color_brewer(palette="Dark2", direction=-1) +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 20)) +
  labs(x="N50",
       y="Sample",
       title = "N50 Pre and Post trimming (Nanopore)")

#TotalBases Dumbbell plot
ggplot(bbstats_filtered, aes(x=Totalbases, y=reorder(Sample,Totalbases))) + 
  geom_line(aes(group = Sample))+
  geom_point(aes(color=data), size=1) +
  theme_light()+
  theme(legend.position="top", axis.text.x = element_text(angle = 90, hjust = 1, size = 6), axis.text.y = element_text(angle = 0, hjust = 1, size = 5)) +
  scale_color_brewer(palette="Dark2", direction=-1) +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 20)) +
  labs(x="Totalbases",
       y="Sample",
       title = "Totalbases Pre and Post trimming (Nanopore)")

#ReadCounts Dumbbell plot
ggplot(bbstats_filtered, aes(x=ReadCount, y=reorder(Sample,ReadCount))) + 
  geom_line(aes(group = Sample))+
  geom_point(aes(color=data), size=1) +
  theme_light()+
  theme(legend.position="top", axis.text.x = element_text(angle = 90, hjust = 1, size = 6), axis.text.y = element_text(angle = 0, hjust = 1, size = 5)) +
  scale_color_brewer(palette="Dark2", direction=-1) +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 20)) +
  labs(x="ReadCount",
       y="Sample",
       title = "ReadCount Pre and Post trimming (Nanopore)")

#LongestRead Dumbbell plot
ggplot(bbstats_filtered, aes(x=LongestRead, y=reorder(Sample,LongestRead))) + 
  geom_line(aes(group = Sample))+
  geom_point(aes(color=data), size=1) +
  theme_light()+
  theme(legend.position="top", axis.text.x = element_text(angle = 90, hjust = 1, size = 6), axis.text.y = element_text(angle = 0, hjust = 1, size = 5)) +
  scale_color_brewer(palette="Dark2", direction=-1) +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 20)) +
  labs(x="Read Length",
       y="Sample",
       title = "LongestRead Pre and Post trimming (Nanopore)")
```

## Easy Way to combine multiple figures into single figure

We will write the all the ggplot functions into respective ggplot variable and then provides all the plots to the function ggarrange() [in ggpubr] as below. We can create a common unique legend for multiple plots.


```{r ggarrange, message=FALSE}
#N50 Dumbbell plot 
N50_dumb <- ggplot(bbstats_filtered, aes(x=N50, y=reorder(Sample,N50))) + 
  geom_line(aes(group = Sample))+
  geom_point(aes(color=data), size=1) +
  theme_light()+
  theme(legend.position="top", axis.text.x = element_text(angle = 90, hjust = 1, size = 6), axis.text.y = element_text(angle = 0, hjust = 1, size = 5)) +
  scale_color_brewer(palette="Dark2", direction=-1) +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 20)) +
  labs(x="N50",
       y="Sample",
       title = "N50 Pre and Post trimming (Nanopore)")
#class(N50_dumb)

#TotalBases
TB_dumb <- ggplot(bbstats_filtered, aes(x=Totalbases, y=reorder(Sample,Totalbases))) + 
  geom_line(aes(group = Sample))+
  geom_point(aes(color=data), size=1) +
  theme_light()+
  theme(legend.position="top", axis.text.x = element_text(angle = 90, hjust = 1, size = 6), axis.text.y = element_text(angle = 0, hjust = 1, size = 5)) +
  scale_color_brewer(palette="Dark2", direction=-1) +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 20)) +
  labs(x="Totalbases",
       y="Sample",
       title = "Totalbases Pre and Post trimming (Nanopore)")

#ReadCounts
RC_dumb <- ggplot(bbstats_filtered, aes(x=ReadCount, y=reorder(Sample,ReadCount))) + 
  geom_line(aes(group = Sample))+
  geom_point(aes(color=data), size=1) +
  theme_light()+
  theme(legend.position="top", axis.text.x = element_text(angle = 90, hjust = 1, size = 6), axis.text.y = element_text(angle = 0, hjust = 1, size = 5)) +
  scale_color_brewer(palette="Dark2", direction=-1) +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 20)) +
  labs(x="ReadCount",
       y="Sample",
       title = "ReadCount Pre and Post trimming (Nanopore)")

#LongestRead
LongCong_dumb <- ggplot(bbstats_filtered, aes(x=LongestRead, y=reorder(Sample,LongestRead))) + 
  geom_line(aes(group = Sample))+
  geom_point(aes(color=data), size=1) +
  theme_light()+
  theme(legend.position="top", axis.text.x = element_text(angle = 90, hjust = 1, size = 6), axis.text.y = element_text(angle = 0, hjust = 1, size = 5)) +
  scale_color_brewer(palette="Dark2", direction=-1) +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 20)) +
  labs(x="Read Length",
       y="Sample",
       title = "LongestRead Pre and Post trimming (Nanopore)")

library(ggpubr)

ggarrange(N50_dumb, TB_dumb, RC_dumb, LongCong_dumb, 
          labels = c("A", "B", "C","D"),
          ncol = 2, nrow = 2,common.legend = TRUE)

# To save in a high quality figure can use the following command
ggsave("bbstats_nanopore.png",dpi = 300, width = 20, height = 10, units = "in")
```
